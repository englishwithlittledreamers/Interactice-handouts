<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Test - Code: 01</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF Autotable plugin for table generation -->
    <script src="https://unpkg.com/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 960px;
            position: relative; /* Added for correct positioning of absolute children */
        }
        /* Custom styles for disabled buttons */
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        /* Style for correct answers */
        .correct-answer {
            @apply text-green-600 font-semibold;
        }
        /* Style for incorrect answers */
        .incorrect-answer {
            @apply text-red-600 font-semibold;
        }
        /* Style for user's selected option in MCQs (radio/checkbox) */
        .selected-option {
            @apply ring-2 ring-blue-500;
        }
        /* Base button styles */
        .btn {
            @apply py-2 px-4 rounded-lg font-semibold transition-all duration-300;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-sm;
        }

        /* Highlight styles */
        .highlight-yellow { background-color: #FEF9C3; } /* Yellow-100 */
        .highlight-blue { background-color: #DBEAFE; } /* Blue-100 */
        .highlight-green { background-color: #D1FAE5; } /* Green-100 */
        .highlight-pink { background-color: #FCE7F3; } /* Pink-100 */
        .highlighted-text {
            display: inline;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto bg-white shadow-xl rounded-2xl p-8 md:p-12 border border-gray-200">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">IELTS Listening Test - Code: 01</h1>

        <!-- Audio Player -->
        <div class="mb-8 p-4 bg-gray-100 rounded-lg shadow-sm flex flex-col items-center">
            <p class="text-lg font-semibold text-gray-700 mb-2">Listen to the audio for the test:</p>
            <div>
                <iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/2117116908&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true"></iframe><div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;"><a href="https://soundcloud.com/little-dreamers-325309503" title="Little Dreamers" target="_blank" style="color: #cccccc; text-decoration: none;">Little Dreamers</a> · <a href="https://soundcloud.com/little-dreamers-325309503/listening-test-code-1" title="Listening Test Code 1" target="_blank" style="color: #cccccc; text-decoration: none;">Listening Test Code 1</a></div>
            
            <p class="text-sm text-gray-600 mt-2 text-center">
                Note: If the audio doesn't play directly, you can click "View on Vocaroo" to open it in a new tab.
            </p>
        </div>

        <!-- Test Sections -->
        <div id="test-sections" class="space-y-8">
            <!-- Section 1 -->
            <div id="section1" class="test-part p-6 bg-blue-50 rounded-xl shadow-inner border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-6">SECTION 1: Questions 1–10</h2>
                <h3 class="text-xl font-semibold text-blue-600 mb-4">Complete the notes below.</h3>
                <p class="text-gray-700 mb-6">Write ONE WORD AND/OR A NUMBER for each answer.</p>

                <h4 class="text-lg font-semibold text-blue-600 mt-6 mb-2">Bankside Recruitment Agency</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>Address of agency: 497 Eastside, Docklands</li>
                    <li>Name of agent: Becky <input type="text" id="answer-1" placeholder="Q1" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                    <li>Phone number: 07866 510333</li>
                    <li>Best to call her in the <input type="text" id="answer-2" placeholder="Q2" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                </ul>

                <h4 class="text-lg font-semibold text-blue-600 mt-6 mb-2">Typical jobs</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>Clerical and admin roles, mainly in the finance industry</li>
                    <li>Must have good <input type="text" id="answer-3" placeholder="Q3" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> skills</li>
                    <li>Jobs are usually for at least one <input type="text" id="answer-4" placeholder="Q4" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                    <li>Pay is usually £<input type="text" id="answer-5" placeholder="Q5" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> per hour</li>
                </ul>

                <h4 class="text-lg font-semibold text-blue-600 mt-6 mb-2">Registration process</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>Wear a <input type="text" id="answer-6" placeholder="Q6" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> to the interview</li>
                    <li>Must bring your <input type="text" id="answer-7" placeholder="Q7" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> to the interview</li>
                    <li>They will ask questions about each applicant’s <input type="text" id="answer-8" placeholder="Q8" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                </ul>

                <h4 class="text-lg font-semibold text-blue-600 mt-6 mb-2">Advantages of using an agency</h4>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>The <input type="text" id="answer-9" placeholder="Q9" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> you receive at interview will benefit you</li>
                    <li>Will get access to vacancies which are not advertised</li>
                    <li>Less <input type="text" id="answer-10" placeholder="Q10" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> is involved in applying for jobs</li>
                </ul>

                <div id="questions-section1-part1" class="space-y-6"></div> <!-- Questions will not be dynamically rendered here, inputs are hardcoded -->
                <div class="flex justify-end mt-8">
                    <button id="nextSection1" class="btn btn-primary">Next Section</button>
                </div>
            </div>

            <!-- Section 2 -->
            <div id="section2" class="test-part p-6 bg-green-50 rounded-xl shadow-inner border border-green-200 hidden">
                <h2 class="text-2xl font-semibold text-green-700 mb-6">SECTION 2: Questions 11–20</h2>
                <h3 class="text-xl font-semibold text-green-600 mb-4">Choose the correct letter, A, B or C.</h3>
                <h4 class="text-lg font-semibold text-green-600 mb-4">Matthews Island Holidays</h4>
                <div id="questions-section2-part1" class="space-y-6"></div> <!-- Q11-14 Multiple Choice -->

                <h3 class="text-xl font-semibold text-green-600 mt-8 mb-4">Complete the table below.</h3>
                <p class="text-gray-700 mb-6">Write ONE WORD AND/OR A NUMBER for each answer.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-700">
                                <th class="py-2 px-4 border-b text-left">Activity</th>
                                <th class="py-2 px-4 border-b text-left">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 1<br>Arrive</td>
                                <td class="py-2 px-4 border-b">Introduction by manager<br>Hotel dining room has view of the <input type="text" id="answer-15" placeholder="Q15" class="w-24 p-1 border border-gray-300 rounded-md text-sm">.</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 2<br>Tynwald Exhibition and Peel</td>
                                <td class="py-2 px-4 border-b">Tynwald may have been founded in <input type="text" id="answer-16" placeholder="Q16" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> not 979.</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 3<br>Trip to Snaefell</td>
                                <td class="py-2 px-4 border-b">Travel along promenade in a tram; train to Laxey;<br>train to the <input type="text" id="answer-17" placeholder="Q17" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> of Snaefell</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 4<br>Free day</td>
                                <td class="py-2 px-4 border-b">Company provides a <input type="text" id="answer-18" placeholder="Q18" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> for local transport and heritage sites.</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 5<br>Take the <input type="text" id="answer-19" placeholder="Q19" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> railway train from Douglas to Port Erin</td>
                                <td class="py-2 px-4 border-b">Free time, then coach to Castletown - former <input type="text" id="answer-20" placeholder="Q20" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> has old castle.</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-4 border-b">Day 6<br>Leave</td>
                                <td class="py-2 px-4 border-b">Leave the island by ferry or plane</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-8">
                    <button id="backSection2" class="btn btn-secondary">Back</button>
                    <button id="nextSection2" class="btn btn-primary">Next Section</button>
                </div>
            </div>

            <!-- Section 3 -->
            <div id="section3" class="test-part p-6 bg-purple-50 rounded-xl shadow-inner border border-purple-200 hidden">
                <h2 class="text-2xl font-semibold text-purple-700 mb-6">SECTION 3: Questions 21–30</h2>
                <h3 class="text-xl font-semibold text-purple-600 mb-4">What did findings of previous research claim about the personality traits a child is likely to have because of their position in the family?</h3>
                <p class="text-gray-700 mb-6">Choose SIX answers from the box and write the correct letter, A-H, next to Questions 21-26.</p>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-6">
                    <p class="font-semibold text-gray-800 mb-2">Personality Traits</p>
                    <ul class="list-disc list-inside text-gray-700 text-sm grid grid-cols-1 md:grid-cols-2 gap-x-4">
                        <li>A. outgoing</li>
                        <li>B. selfish</li>
                        <li>C. independent</li>
                        <li>D. attention-seeking</li>
                        <li>E. introverted</li>
                        <li>F. co-operative</li>
                        <li>G. caring</li>
                        <li>H. competitive</li>
                    </ul>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-2">
                        <label for="answer-21" class="w-48 text-gray-700">21. the eldest child</label>
                        <input type="text" id="answer-21" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="answer-22" class="w-48 text-gray-700">22. a middle child</label>
                        <input type="text" id="answer-22" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="answer-23" class="w-48 text-gray-700">23. the youngest child</label>
                        <input type="text" id="answer-23" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="answer-24" class="w-48 text-gray-700">24. a twin</label>
                        <input type="text" id="answer-24" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="answer-25" class="w-48 text-gray-700">25. an only child</label>
                        <input type="text" id="answer-25" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="answer-26" class="w-48 text-gray-700">26. a child with much older siblings</label>
                        <input type="text" id="answer-26" placeholder="A-H" class="w-16 p-1 border border-gray-300 rounded-md text-sm uppercase">
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-purple-600 mt-8 mb-4">Choose the correct letter, A, B or C.</h3>
                <div id="questions-section3-part2" class="space-y-6"></div> <!-- Q27-28 Multiple Choice -->

                <h3 class="text-xl font-semibold text-purple-600 mt-8 mb-4">Choose TWO letters, A-E.</h3>
                <p class="text-gray-700 mb-6">Which TWO experiences of sibling rivalry do the speakers agree has been valuable for them?</p>
                <div id="questions-section3-part3" class="space-y-6"></div> <!-- Q29-30 Choose Two -->

                <div class="flex justify-between items-center mt-8">
                    <button id="backSection3" class="btn btn-secondary">Back</button>
                    <button id="nextSection3" class="btn btn-primary">Next Section</button>
                </div>
            </div>

            <!-- Section 4 -->
            <div id="section4" class="test-part p-6 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200 hidden">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-6">SECTION 4: Questions 31–40</h2>
                <h3 class="text-xl font-semibold text-yellow-600 mb-4">Complete the notes below.</h3>
                <p class="text-gray-700 mb-6">Write ONE WORD ONLY for each answer.</p>

                <h4 class="text-lg font-semibold text-yellow-600 mt-6 mb-2">The Eucalyptus Tree in Australia</h4>
                <p class="text-gray-700 font-semibold mt-4">Importance</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>it provides <input type="text" id="answer-31" placeholder="Q31" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> and food for a wide range of species</li>
                    <li>its leaves provide <input type="text" id="answer-32" placeholder="Q32" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> which is used to make a disinfectant</li>
                </ul>

                <p class="text-gray-700 font-semibold mt-4">Reasons for present decline in number</p>
                <p class="text-gray-700 font-semibold mt-4">A) Diseases</p>
                <p class="text-gray-700 ml-4">(i) ‘Mundulla Yellows’</p>
                <ul class="list-disc list-inside text-gray-700 ml-8 space-y-2 mb-6">
                    <li>Cause – lime used for making <input type="text" id="answer-33" placeholder="Q33" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> was absorbed</li>
                    <li>– trees were unable to take in necessary iron through their roots</li>
                </ul>
                <p class="text-gray-700 ml-4">(ii) ‘Bell-miner Associated Die-back’</p>
                <ul class="list-disc list-inside text-gray-700 ml-8 space-y-2 mb-6">
                    <li>Cause – <input type="text" id="answer-34" placeholder="Q34" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> feed on eucalyptus leaves</li>
                    <li>– they secrete a substance containing sugar</li>
                    <li>– bell-miner birds are attracted by this and keep away other species</li>
                </ul>

                <p class="text-gray-700 font-semibold mt-4">B) Bushfires</p>
                <p class="text-gray-700 font-semibold mt-4">William Jackson’s theory:</p>
                <ul class="list-disc list-inside text-gray-700 space-y-2 mb-6">
                    <li>high-frequency bushfires have impact on vegetation, resulting in the growth of <input type="text" id="answer-35" placeholder="Q35" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                    <li>mid-frequency bushfires result in the growth of eucalyptus forests, because they:</li>
                    <ul class="list-circle list-inside text-gray-700 ml-4 space-y-2">
                        <li>– make more <input type="text" id="answer-36" placeholder="Q36" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> available to the trees</li>
                        <li>– maintain the quality of the <input type="text" id="answer-37" placeholder="Q37" class="w-24 p-1 border border-gray-300 rounded-md text-sm"></li>
                    </ul>
                    <li>low-frequency bushfires result in the growth of <input type="text" id="answer-38" placeholder="Q38" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> ‘rainforest’, which is:</li>
                    <ul class="list-circle list-inside text-gray-700 ml-4 space-y-2">
                        <li>– a <input type="text" id="answer-39" placeholder="Q39" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> Ecosystem</li>
                        <li>– an ideal environment for the <input type="text" id="answer-40" placeholder="Q40" class="w-24 p-1 border border-gray-300 rounded-md text-sm"> of the bell-miner</li>
                    </ul>
                </ul>

                <div id="questions-section4-part1" class="space-y-6"></div> <!-- Q31-40 Fill-in-the-blank (with explicit inputs) -->

                <div class="flex justify-between items-center mt-8">
                    <button id="backSection4" class="btn btn-secondary">Back</button>
                    <button id="submitTest" class="btn btn-primary">Submit Test</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200 hidden text-center">
                <p id="submission-message" class="text-xl font-bold text-gray-700 mb-8">Your answers have been submitted, click the button below to download your result!</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-8">
                    <button id="downloadPdf" class="btn btn-primary">Download PDF Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Highlight Toolbar -->
    <div id="floatingToolbar" class="absolute hidden bg-gray-800 p-2 rounded-lg shadow-xl flex items-center space-x-2 z-50">
        <button id="toolbarClearBtn" title="Clear Highlight" class="p-1 rounded-full bg-gray-600 hover:bg-gray-700 text-white text-lg leading-none flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="toolbarYellow" title="Highlight Yellow" class="w-6 h-6 rounded-full cursor-pointer bg-yellow-400 hover:bg-yellow-500 transition-colors duration-200" data-color="highlight-yellow"></div>
        <div id="toolbarBlue" title="Highlight Blue" class="w-6 h-6 rounded-full cursor-pointer bg-blue-400 hover:bg-blue-500 transition-colors duration-200" data-color="highlight-blue"></div>
        <div id="toolbarGreen" title="Highlight Green" class="w-6 h-6 rounded-full cursor-pointer bg-green-400 hover:bg-green-500 transition-colors duration-200" data-color="highlight-green"></div>
        <div id="toolbarPink" title="Highlight Pink" class="w-6 h-6 rounded-full cursor-pointer bg-pink-400 hover:bg-pink-500 transition-colors duration-200" data-color="highlight-pink"></div>
    </div>

    <script>
        window.onload = function() {
            const testData = {
                section1: {
                    part1: [ // Q1-10 Fill-in-the-blank
                        { question: "Name of agent: Becky 1 _______", correctAnswer: "JAMIESON" },
                        { question: "Best to call her in the 2 _______", correctAnswer: "AFTERNOON" },
                        { question: "Must have good 3 _______ skills", correctAnswer: "COMMUNICATION" },
                        { question: "Jobs are usually for at least one 4 _______", correctAnswer: "WEEK" },
                        { question: "Pay is usually 5 £ _______ per hour", correctAnswer: "10" },
                        { question: "Wear a 6 _______ to the interview", correctAnswer: "SUIT" },
                        { question: "Must bring your 7 _______ to the interview", correctAnswer: "PASSPORT" },
                        { question: "They will ask questions about each applicant’s 8 _______", correctAnswer: "PERSONALITY" },
                        { question: "The 9 _______ you receive at interview will benefit you", correctAnswer: "FEEDBACK" },
                        { question: "Less 10 _______ is involved in applying for jobs", correctAnswer: "TIME" }
                    ]
                },
                section2: {
                    part1: [ // Q11-14 Multiple Choice
                        {
                            question: "11. According to the speaker, the company",
                            options: ["A. has been in business for longer than most of its competitors.", "B. arranges holidays to more destinations than its competitors.", "C. has more customers than its competitors."],
                            correctAnswer: "A"
                        },
                        {
                            question: "12. Where can customers meet the tour manager before travelling to the Isle of Man?",
                            options: ["A. Liverpool", "B. Heysham", "C. Luton"],
                            correctAnswer: "B"
                        },
                        {
                            question: "13. How many lunches are included in the price of the holiday?",
                            options: ["A. three", "B. four", "C. five"],
                            correctAnswer: "A"
                        },
                        {
                            question: "14. Customers have to pay extra for",
                            options: ["A. guaranteeing themselves a larger room.", "B. booking at short notice.", "C. transferring to another date."],
                            correctAnswer: "C"
                        }
                    ],
                    part2: [ // Q15-20 Table Fill-in-the-blank
                        { question: "15", correctAnswer: "RIVER" },
                        { question: "16", correctAnswer: "1422" },
                        { question: "17", correctAnswer: "TOP" },
                        { question: "18", correctAnswer: "PASS" },
                        { question: "19", correctAnswer: "STEAM" },
                        { question: "20", correctAnswer: "CAPITAL" }
                    ]
                },
                section3: {
                    part1: [ // Q21-26 Matching
                        { question: "21. the eldest child", correctAnswer: "G" }, // G. caring
                        { question: "22. a middle child", correctAnswer: "F" }, // F. co-operative
                        { question: "23. the youngest child", correctAnswer: "A" }, // A. outgoing
                        { question: "24. a twin", correctAnswer: "E" }, // E. introverted
                        { question: "25. an only child", correctAnswer: "B" }, // B. selfish
                        { question: "26. a child with much older siblings", correctAnswer: "C" }  // C. independent
                    ],
                    part2: [ // Q27-28 Multiple Choice
                        {
                            question: "27. What do the speakers say about the evidence relating to birth order and academic success?",
                            options: ["A. There is conflicting evidence about whether oldest children perform best in intelligence tests.", "B. There is little doubt that birth order has less influence on academic achievement than socio-economic status.", "C. Some studies have neglected to include important factors such as family size."],
                            correctAnswer: "C"
                        },
                        {
                            question: "28. What does Ruth think is surprising about the difference in oldest children’s academic performance?",
                            options: ["A. It is mainly thanks to their roles as teachers for their younger siblings.", "B. The advantages they have only lead to a slightly higher level of achievement.", "C. The extra parental attention they receive at a young age makes little difference."],
                            correctAnswer: "A"
                        }
                    ],
                    part3: [ // Q29-30 Choose TWO
                        {
                            question: "Which TWO experiences of sibling rivalry do the speakers agree has been valuable for them?",
                            options: ["A. learning to share", "B. learning to stand up for oneself", "C. learning to be a good loser", "D. learning to be tolerant", "E. learning to say sorry"],
                            correctAnswer: ["B", "D"], // Correct letters, order doesn't matter for check, but stored as array
                            type: "checkbox"
                        }
                    ]
                },
                section4: {
                    part1: [ // Q31-40 Fill-in-the-blank (explicit inputs)
                        { question: "31", correctAnswer: "SHELTER" },
                        { question: "32", correctAnswer: "OIL" },
                        { question: "33", correctAnswer: "ROADS" },
                        { question: "34", correctAnswer: "INSECTS" },
                        { question: "35", correctAnswer: "GRASS" },
                        { question: "36", correctAnswer: "WATER" },
                        { question: "37", correctAnswer: "SOIL" },
                        { question: "38", correctAnswer: "DRY" },
                        { question: "39", correctAnswer: "SIMPLE" },
                        { question: "40", correctAnswer: "NEST" }
                    ]
                }
            };

            // User's answers storage, initialized with empty arrays for each part/sub-part
            const userAnswers = {
                section1: { part1: Array(10).fill("") },
                section2: { part1: Array(4).fill(""), part2: Array(6).fill("") }, // 4 MCQs, 6 table
                section3: { part1: Array(6).fill(""), part2: Array(2).fill(""), part3: Array(1).fill([]) }, // 6 Matching, 2 MCQs, 1 Checkbox (2 answers)
                section4: { part1: Array(10).fill("") }
            };

            // Total score - Initialize to 0 globally, reset when showing section1 if starting fresh test.
            let score = 0;

            // --- Helper Functions ---

            /**
             * Hides all test parts.
             */
            function hideAllParts() {
                document.querySelectorAll('.test-part').forEach(part => {
                    part.classList.add('hidden');
                });
            }

            /**
             * Enables all input elements (text, radio, checkbox) within a given section.
             * @param {string} sectionId - The ID of the section.
             */
            function enableInputsInCurrentSection(sectionId) {
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) {
                    sectionElement.querySelectorAll('input, select, textarea').forEach(input => {
                        input.disabled = false;
                    });
                }
            }

            /**
             * Displays a specific test part and enables its inputs.
             * @param {string} sectionId - The ID of the section to display (e.g., 'section1').
             */
            function showSection(sectionId) {
                hideAllParts();
                document.getElementById(sectionId).classList.remove('hidden');
                enableInputsInCurrentSection(sectionId); // Enable inputs when showing the section
            }

            /**
             * Calculates the global question number for a specific question within a section and part.
             * This function is simplified as it's primarily used for input IDs and feedback.
             * @param {string} sectionId - The ID of the section.
             * @param {string} partId - The ID of the part within the section.
             * @param {number} qIndex - The zero-based index of the question within its part.
             * @returns {number} The global question number.
             */
            function getGlobalQuestionNumber(sectionId, partId, qIndex) {
                let currentQuestionCount = 0;
                // Ordered list of parts to ensure correct global question numbering
                const orderedParts = [
                    { section: 'section1', part: 'part1' },
                    { section: 'section2', part: 'part1' },
                    { section: 'section2', part: 'part2' },
                    { section: 'section3', part: 'part1' },
                    { section: 'section3', part: 'part2' },
                    { section: 'section3', part: 'part3' },
                    { section: 'section4', part: 'part1' }
                ];

                for (const item of orderedParts) {
                    const sec = item.section;
                    const p = item.part;

                    // Ensure testData[sec] and testData[sec][p] exist before proceeding
                    if (!testData[sec] || !testData[sec][p]) {
                        console.warn(`Missing or invalid testData for section: ${sec}, part: ${p}`);
                        continue; // Skip this iteration if data is missing
                    }

                    // If we are in the target section and part
                    if (sec === sectionId && p === partId) {
                        let questionsBeforeCurrentInPart = 0;
                        for (let i = 0; i < qIndex; i++) {
                            const prevQ = testData[sec][p][i];
                            // Each checkbox (choose two) question counts as 2, others as 1
                            questionsBeforeCurrentInPart += (prevQ && prevQ.type === "checkbox" && prevQ.correctAnswer.length === 2) ? 2 : 1;
                        }
                        return currentQuestionCount + questionsBeforeCurrentInPart + 1;
                    }

                    // Accumulate count for parts before the target part
                    testData[sec][p].forEach(q => {
                        currentQuestionCount += (q && q.type === "checkbox" && q.correctAnswer.length === 2) ? 2 : 1;
                    });
                }
                // Fallback for cases where the question might not be found (should ideally not happen)
                console.error(`Could not determine global question number for ${sectionId}-${partId}-${qIndex}`);
                return -1;
            }


            /**
             * Renders questions (MCQ, Checkbox, or Fill-in-the-blank) for a given part.
             * This function handles both pre-existing HTML inputs and dynamic rendering.
             * @param {string} sectionId - The ID of the section.
             * @param {string} partId - The ID of the part (e.g., 'part1', 'part2').
             * @param {Array<Object>} questions - An array of question objects.
             */
            function renderQuestions(sectionId, partId, questions) {
                const container = document.getElementById(`questions-${sectionId}-${partId}`);
                // If container exists, it means we are dynamically rendering into it.
                // If it doesn't, we assume inputs are hardcoded in the main HTML.

                questions.forEach((q, qIndex) => {
                    const globalQuestionNumber = getGlobalQuestionNumber(sectionId, partId, qIndex);

                    // Handle inputs that are explicitly defined in the static HTML
                    const hardcodedInputId = `answer-${globalQuestionNumber}`; // Using global Q number as ID for hardcoded inputs
                    const hardcodedInputField = document.getElementById(hardcodedInputId);

                    if (hardcodedInputField) {
                        // This question is hardcoded in the HTML. Just attach listener and pre-fill.
                        hardcodedInputField.value = userAnswers[sectionId][partId][qIndex] || '';
                        hardcodedInputField.addEventListener('input', (event) => {
                            userAnswers[sectionId][partId][qIndex] = event.target.value.trim();
                        });
                        // For matching questions in section3 part1, ensure input is uppercase
                        if (sectionId === 'section3' && partId === 'part1') {
                            hardcodedInputField.addEventListener('input', (event) => {
                                userAnswers[sectionId][partId][qIndex] = event.target.value.trim().toUpperCase();
                            });
                        }
                        return; // Skip dynamic rendering for hardcoded inputs
                    }

                    // If not hardcoded, proceed with dynamic rendering into the container
                    if (container) {
                        const questionDiv = document.createElement('div');
                        questionDiv.classList.add('mb-4', 'p-4', 'bg-white', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-100');

                        if (q.options) { // Multiple choice or Checkbox
                            let questionTextForDisplay = q.question;
                            // Prepend question number only if it's not already part of the question string
                            if (!questionTextForDisplay.match(/^\d+\.\s*/)) {
                                questionTextForDisplay = `${globalQuestionNumber}. ${questionTextForDisplay}`;
                            }

                            const inputType = q.type === "checkbox" ? "checkbox" : "radio";
                            questionDiv.innerHTML = `
                                <p class="font-semibold text-lg mb-3 text-gray-800">${questionTextForDisplay}</p>
                                <div class="space-y-2">
                                    ${q.options.map((option, oIndex) => {
                                        const optionLetter = String.fromCharCode(65 + oIndex); // A, B, C, D, E
                                        const inputName = `${inputType}-q${globalQuestionNumber}`;
                                        const isChecked = Array.isArray(userAnswers[sectionId][partId][qIndex]) ?
                                                          userAnswers[sectionId][partId][qIndex].includes(optionLetter) :
                                                          userAnswers[sectionId][partId][qIndex] === optionLetter;

                                        return `
                                            <label class="flex items-center p-3 rounded-md cursor-pointer hover:bg-gray-50 transition-colors duration-200 border border-gray-200 ${isChecked ? 'selected-option' : ''}">
                                                <input type="${inputType}" name="${inputName}" value="${optionLetter}" class="form-${inputType} h-5 w-5 text-blue-600" ${isChecked ? 'checked' : ''}>
                                                <span class="ml-3 text-gray-700">${optionLetter}. ${option.replace(/^[A-E]\.\s*/, '')}</span>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                                <div id="feedback-${globalQuestionNumber}" class="mt-2 text-sm"></div>
                            `;
                            container.appendChild(questionDiv);

                            // Add event listener to store selected answer(s)
                            questionDiv.querySelectorAll(`input[name="${inputType}-q${globalQuestionNumber}"]`).forEach(input => {
                                input.addEventListener('change', (event) => {
                                    if (inputType === "radio") {
                                        userAnswers[sectionId][partId][qIndex] = event.target.value;
                                    } else { // Checkbox
                                        let currentSelections = userAnswers[sectionId][partId][qIndex] || [];
                                        if (event.target.checked) {
                                            currentSelections.push(event.target.value);
                                        } else {
                                            currentSelections = currentSelections.filter(val => val !== event.target.value);
                                        }
                                        userAnswers[sectionId][partId][qIndex] = currentSelections;
                                    }
                                    // Visually highlight the selected option(s)
                                    questionDiv.querySelectorAll('label').forEach(label => {
                                        const checkbox = label.querySelector(`input[name="${inputType}-q${globalQuestionNumber}"]`);
                                        if (checkbox && checkbox.checked) {
                                            label.classList.add('selected-option');
                                        } else {
                                            label.classList.remove('selected-option');
                                        }
                                    });
                                });
                            });
                        } else { // Dynamically rendered Fill-in-the-blank (e.g., if a new text input question type was added)
                            // This part of the code might be redundant if all fill-in-the-blanks are hardcoded in HTML.
                            // However, it's kept as a general dynamic rendering fallback.
                            let displayQuestionText = q.question;
                            if (!displayQuestionText.match(/^\d+\.\s*/)) {
                                displayQuestionText = `${globalQuestionNumber}. ${displayQuestionText}`;
                            }
                            displayQuestionText = displayQuestionText.replace('_______', `<input type="text" id="answer-${globalQuestionNumber}" placeholder="Type your answer here..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">`);

                            questionDiv.innerHTML = `
                                <p class="font-semibold text-lg mb-3 text-gray-800">${displayQuestionText}</p>
                                <div id="feedback-${globalQuestionNumber}" class="mt-2 text-sm"></div>
                            `;
                            container.appendChild(questionDiv);

                            const inputField = document.getElementById(`answer-${globalQuestionNumber}`);
                            if (inputField) {
                                inputField.value = userAnswers[sectionId][partId][qIndex] || '';
                                inputField.addEventListener('input', (event) => {
                                    userAnswers[sectionId][partId][qIndex] = event.target.value.trim();
                                });
                            }
                        }
                    }
                });
            }

            /**
             * Checks answers for a part and updates score and feedback.
             * This function handles both single-choice and multiple-choice (checkbox) questions.
             * @param {string} sectionId - The ID of the section.
             * @param {string} partId - The ID of the part.
             */
            function checkAnswers(sectionId, partId) {
                const questions = testData[sectionId][partId];

                questions.forEach((q, qIndex) => {
                    const globalQuestionNumber = getGlobalQuestionNumber(sectionId, partId, qIndex);
                    const userAnswer = userAnswers[sectionId][partId][qIndex];
                    const feedbackDiv = document.getElementById(`feedback-${globalQuestionNumber}`);
                    let isCorrect = false;

                    // Disable inputs
                    // This section will now disable inputs for the section being *checked*
                    // inputs are re-enabled when the section is shown via showSection()
                    if (q.options) { // MCQ or Checkbox
                        document.querySelectorAll(`input[name="${q.type || 'radio'}-q${globalQuestionNumber}"]`).forEach(input => input.disabled = true);
                    } else { // Fill-in-the-blank
                        const inputField = document.getElementById(`answer-${globalQuestionNumber}`);
                        if (inputField) inputField.disabled = true;
                    }

                    if (q.type === "checkbox") { // Choose TWO answers
                        const correctAnswersSet = new Set(q.correctAnswer.map(ans => ans.toUpperCase()));
                        const userAnswersSet = new Set((userAnswer || []).map(ans => ans.toUpperCase()));

                        const allCorrectSelected = [...correctAnswersSet].every(ans => userAnswersSet.has(ans));
                        const noIncorrectSelected = [...userAnswersSet].every(ans => correctAnswersSet.has(ans));

                        isCorrect = allCorrectSelected && noIncorrectSelected && userAnswersSet.size === correctAnswersSet.size;

                        if (isCorrect) {
                            score += q.correctAnswer.length; // Add 2 for 'choose two' questions
                        }

                    } else if (q.options) { // Single choice MCQ (radio)
                        isCorrect = (userAnswer && userAnswer.toUpperCase() === q.correctAnswer.toUpperCase());
                        if (isCorrect) {
                            score++;
                        }
                    } else { // Fill-in-the-blank (including hardcoded and dynamically rendered ones)
                        const normalizedUserAnswer = (userAnswer || '').toLowerCase();
                        const normalizedCorrectAnswer = q.correctAnswer.toLowerCase();
                        isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

                        // Specific checks for relevant questions based on global question number
                        if (globalQuestionNumber >= 1 && globalQuestionNumber <= 10) { // Section 1 fill-in-the-blanks
                             isCorrect = normalizedUserAnswer === testData.section1.part1[globalQuestionNumber - 1].correctAnswer.toLowerCase();
                             if (globalQuestionNumber === 5) { // Special case for Q5 (10/TEN)
                                 isCorrect = (normalizedUserAnswer === '10' || normalizedUserAnswer === 'ten');
                             }
                        } else if (globalQuestionNumber >= 15 && globalQuestionNumber <= 20) { // Section 2 table fill-in-the-blanks
                            isCorrect = normalizedUserAnswer === testData.section2.part2[globalQuestionNumber - 15].correctAnswer.toLowerCase();
                            if (globalQuestionNumber === 16) { // Special case for Q16 (1422 or fourteen twenty-two)
                                 isCorrect = (normalizedUserAnswer === '1422' || normalizedUserAnswer === 'fourteen twenty-two');
                             }
                        } else if (globalQuestionNumber >= 21 && globalQuestionNumber <= 26) { // Section 3 matching
                            isCorrect = normalizedUserAnswer === testData.section3.part1[globalQuestionNumber - 21].correctAnswer.toLowerCase();
                        } else if (globalQuestionNumber >= 31 && globalQuestionNumber <= 40) { // Section 4 fill-in-the-blanks
                            isCorrect = normalizedUserAnswer === testData.section4.part1[globalQuestionNumber - 31].correctAnswer.toLowerCase();
                        }

                        if (isCorrect) {
                            score++;
                        }
                    }

                    if (feedbackDiv) { // Ensure feedbackDiv exists
                        if (isCorrect) {
                            feedbackDiv.classList.remove('incorrect-answer');
                            feedbackDiv.classList.add('correct-answer');
                            feedbackDiv.textContent = `Correct!`;
                        } else {
                            feedbackDiv.classList.remove('correct-answer');
                            feedbackDiv.classList.add('incorrect-answer');
                            let correctDisplay = q.options ? q.correctAnswer : `"${q.correctAnswer}"`;
                            if (q.type === "checkbox") {
                                correctDisplay = `"${q.correctAnswer.join(', ')}"`;
                            }
                            feedbackDiv.textContent = `Incorrect. The correct answer is ${correctDisplay}.`;
                        }
                    }
                });
            }

            /**
             * Displays the final results.
             */
            function showResults() {
                hideAllParts();
                document.getElementById('results').classList.remove('hidden');
            }


            /**
             * Generates and downloads a PDF report of the test results.
             */
            function generatePdfReport() {
                console.log("generatePdfReport called.");
                if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                    console.error("jsPDF library (window.jspdf.jsPDF) not loaded. Cannot generate PDF.");
                    alert("PDF generation is not available. Please ensure your browser allows scripts from CDNs.");
                    return;
                }
                console.log("jsPDF is loaded.");
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                console.log("jsPDF document initialized.");

                doc.setFontSize(22);
                doc.text("Results", 105, 20, { align: 'center' });
                doc.setFontSize(10);
                const now = new Date();
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                doc.text(`Report generated on: ${now.toLocaleDateString('en-US', dateOptions)}`, 105, 30, { align: 'center' });

                let totalPossibleScore = 0;
                // Recalculate totalPossibleScore based on the actual structure of `testData`
                const orderedPartsForScore = [
                    { section: 'section1', part: 'part1' },
                    { section: 'section2', part: 'part1' },
                    { section: 'section2', part: 'part2' },
                    { section: 'section3', part: 'part1' },
                    { section: 'section3', part: 'part2' },
                    { section: 'section3', part: 'part3' },
                    { section: 'section4', part: 'part1' }
                ];

                for (const item of orderedPartsForScore) {
                    const sec = item.section;
                    const p = item.part;
                    if (testData[sec] && testData[sec][p]) {
                        testData[sec][p].forEach(q => {
                            if (q && q.type === "checkbox" && q.correctAnswer.length === 2) {
                                totalPossibleScore += 2;
                            } else {
                                totalPossibleScore += 1;
                            }
                        });
                    }
                }

                doc.setFontSize(14);
                doc.text(`Total Score: ${score} out of ${totalPossibleScore} correct!`, 105, 45, { align: 'center' });

                doc.setFontSize(16);
                doc.text("Your Answers", 14, 65);

                const headers = [["Question #", "Your Answer", "Correct Answer", "Status"]];
                const data = [];

                let currentQuestionNumberForPdf = 1;

                // Loop through testData to populate PDF data based on the ordered parts
                for (const item of orderedPartsForScore) {
                    const secKey = item.section;
                    const partKey = item.part;

                    if (!testData[secKey] || !testData[secKey][partKey]) {
                        console.warn(`Skipping missing testData for PDF generation: ${secKey}-${partKey}`);
                        continue;
                    }

                    testData[secKey][partKey].forEach((q, qIndex) => {
                        const userAnswer = userAnswers[secKey][partKey][qIndex];
                        let status = "Not Answered";
                        let correctValueDisplay;
                        let userAnswerDisplay;
                        let isCorrectPdf = false; // Flag for correctness for PDF reporting

                        if (q.type === "checkbox") {
                            const correctAnswersSet = new Set(q.correctAnswer.map(ans => ans.toUpperCase()));
                            const userAnswersSet = new Set((userAnswer || []).map(ans => ans.toUpperCase()));
                            isCorrectPdf = [...correctAnswersSet].every(ans => userAnswersSet.has(ans)) &&
                                           [...userAnswersSet].every(ans => correctAnswersSet.has(ans)) &&
                                           userAnswersSet.size === correctAnswersSet.size;

                            status = isCorrectPdf ? "Correct" : "Incorrect";
                            if (!userAnswer || userAnswer.length === 0) status = "Not Answered";

                            correctValueDisplay = q.correctAnswer.map(ans => {
                                const optionIndex = ans.charCodeAt(0) - 65;
                                return q.options[optionIndex] ? `${ans}. ${q.options[optionIndex].replace(/^[A-E]\.\s*/, '')}` : ans;
                            }).join(', ');

                            userAnswerDisplay = (userAnswer && userAnswer.length > 0) ? userAnswer.map(ans => {
                                const optionIndex = ans.charCodeAt(0) - 65;
                                return q.options[optionIndex] ? `${ans}. ${q.options[optionIndex].replace(/^[A-E]\.\s*/, '')}` : ans;
                            }).join(', ') : 'N/A';

                        } else if (q.options) { // Single choice MCQ (radio)
                            isCorrectPdf = (userAnswer && userAnswer.toUpperCase() === q.correctAnswer.toUpperCase());
                            status = isCorrectPdf ? "Correct" : "Incorrect";
                            if (!userAnswer) status = "Not Answered";

                            const optionIndex = q.correctAnswer.charCodeAt(0) - 65;
                            correctValueDisplay = q.options[optionIndex] ? `${q.correctAnswer}. ${q.options[optionIndex]}` : q.correctAnswer;
                            const userAnswerOptionIndex = userAnswer ? userAnswer.charCodeAt(0) - 65 : -1;
                            userAnswerDisplay = (userAnswer && q.options[userAnswerOptionIndex]) ? `${userAnswer}. ${q.options[userAnswerOptionIndex]}` : 'N/A';

                        } else { // Fill-in-the-blank or Matching (text input)
                            const normalizedUserAnswer = (userAnswer || '').toLowerCase();
                            const normalizedCorrectAnswer = q.correctAnswer.toLowerCase();
                            isCorrectPdf = normalizedUserAnswer === normalizedCorrectAnswer;

                            // Special handling for Q5 (10/TEN) and other fill-in-the-blanks for PDF
                            if (currentQuestionNumberForPdf === 5) {
                                isCorrectPdf = (normalizedUserAnswer === '10' || normalizedUserAnswer === 'ten');
                            }
                             if (currentQuestionNumberForPdf >= 15 && currentQuestionNumberForPdf <= 20) {
                                isCorrectPdf = normalizedUserAnswer === testData.section2.part2[currentQuestionNumberForPdf - 15].correctAnswer.toLowerCase();
                                if (currentQuestionNumberForPdf === 16) {
                                     isCorrectPdf = (normalizedUserAnswer === '1422' || normalizedUserAnswer === 'fourteen twenty-two');
                                 }
                            }
                            if (currentQuestionNumberForPdf >= 21 && currentQuestionNumberForPdf <= 26) {
                                isCorrectPdf = normalizedUserAnswer === testData.section3.part1[currentQuestionNumberForPdf - 21].correctAnswer.toLowerCase();
                            }
                            if (currentQuestionNumberForPdf >= 31 && currentQuestionNumberForPdf <= 40) {
                                isCorrectPdf = normalizedUserAnswer === testData.section4.part1[currentQuestionNumberForPdf - 31].correctAnswer.toLowerCase();
                            }

                            status = isCorrectPdf ? "Correct" : "Incorrect";
                            if (!userAnswer) status = "Not Answered";

                            correctValueDisplay = q.correctAnswer;
                            userAnswerDisplay = userAnswer || 'N/A';
                        }

                        let questionNumberForDisplay = currentQuestionNumberForPdf.toString();
                        if (q.type === "checkbox" && q.correctAnswer.length === 2) {
                            questionNumberForDisplay = `${currentQuestionNumberForPdf}-${currentQuestionNumberForPdf + 1}`;
                        }

                        data.push([
                            questionNumberForDisplay,
                            userAnswerDisplay,
                            correctValueDisplay,
                            status
                        ]);

                        currentQuestionNumberForPdf += (q.type === "checkbox" && q.correctAnswer.length === 2) ? 2 : 1;
                    });
                }

                doc.autoTable({
                    startY: 75,
                    head: headers,
                    body: data,
                    theme: 'striped',
                    styles: { font: 'Inter', fontSize: 9, cellPadding: 2, valign: 'middle' },
                    headStyles: { fillColor: [30, 58, 138], textColor: [255, 255, 255], fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 20 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 50 },
                        3: { cellWidth: 30 }
                    },
                    didParseCell: function (data) {
                        if (data.section === 'body' && data.column.index === 3) { // Status column
                            if (data.cell.raw === 'Correct') {
                                data.cell.styles.textColor = [34, 139, 34]; // Forest green
                            } else if (data.cell.raw === 'Incorrect') {
                                data.cell.styles.textColor = [220, 20, 60]; // Crimson red
                            }
                        }
                    }
                });

                console.log("PDF data prepared, attempting to save.");
                doc.save("Results.pdf");
                console.log("doc.save() called.");
            }


            // --- Highlight Toolbar Logic ---
            const testContainer = document.querySelector('.container'); // The main test content area
            const floatingToolbar = document.getElementById('floatingToolbar');
            const toolbarClearBtn = document.getElementById('toolbarClearBtn');
            const toolbarYellow = document.getElementById('toolbarYellow');
            const toolbarBlue = document.getElementById('toolbarBlue');
            const toolbarGreen = document.getElementById('toolbarGreen');
            const toolbarPink = document.getElementById('toolbarPink');

            let lastSelectionRange = null;

            // Function to apply highlight to selected text
            function applyHighlight(colorClass) {
                console.log(`Attempting to apply highlight: ${colorClass}`);
                const selection = window.getSelection();
                let range;

                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    range = selection.getRangeAt(0);
                    console.log("Using current selection range.");
                } else if (lastSelectionRange && !lastSelectionRange.collapsed) {
                    // If no active selection, but a previous one was stored, re-select it.
                    range = lastSelectionRange;
                    selection.removeAllRanges(); // Clear current selection before re-adding
                    selection.addRange(range);
                    console.log("Using last stored selection range.");
                } else {
                    console.log("No valid text selection or last selection found for highlighting. Exiting.");
                    return;
                }

                const selectedText = range.toString().trim();
                if (!selectedText) {
                    console.log("Selected text is empty after trim. Exiting.");
                    return;
                }

                const span = document.createElement('span');
                span.classList.add(colorClass, 'highlighted-text');
                console.log("Created span for highlight:", span);

                try {
                    // Check if the range can be surrounded. This is a common point of failure.
                    // If the selection partially selects an element, or spans across multiple non-text nodes,
                    // surroundContents can fail.
                    range.surroundContents(span);
                    console.log("surroundContents successful.");

                    // Update the selection to precisely cover the new span
                    selection.removeAllRanges();
                    const newRange = document.createRange();
                    newRange.selectNode(span);
                    selection.addRange(newRange);
                    lastSelectionRange = newRange.cloneRange(); // Store a fresh clone

                    console.log("Highlight applied successfully.");
                } catch (e) {
                    console.error("Error applying highlight (likely non-contiguous selection or DOM structure issue):", e);
                    // More user-friendly feedback:
                    alert("Could not highlight this selection. Please try selecting a continuous block of text within a single paragraph or element.");
                } finally {
                    floatingToolbar.classList.add('hidden'); // Always hide toolbar after action
                }
            }

            // Function to clear highlight from selected text
            function clearSelectedHighlight() {
                console.log("Attempting to clear highlight.");
                const selection = window.getSelection();
                let rangeToClear;

                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    rangeToClear = selection.getRangeAt(0);
                    console.log("Using current selection range for clearing.");
                } else if (lastSelectionRange && !lastSelectionRange.collapsed) {
                    rangeToClear = lastSelectionRange;
                    selection.removeAllRanges();
                    selection.addRange(rangeToClear);
                    console.log("Using last stored selection range for clearing.");
                } else {
                    console.log("No text selected to clear highlight.");
                    return;
                }

                let commonAncestor = rangeToClear.commonAncestorContainer;
                let highlightedSpan = null;

                // Traverse up the DOM from the common ancestor to find a 'highlighted-text' span
                let currentNode = commonAncestor;
                // Ensure we stop traversing if we go outside the testContainer
                while (currentNode && currentNode !== testContainer.parentNode && currentNode.parentNode) {
                    if (currentNode.nodeType === Node.ELEMENT_NODE && currentNode.classList.contains('highlighted-text')) {
                        highlightedSpan = currentNode;
                        break;
                    }
                    currentNode = currentNode.parentNode;
                }

                if (highlightedSpan && highlightedSpan.parentNode) {
                    console.log("Found highlighted span to clear:", highlightedSpan);
                    const parentOfHighlighted = highlightedSpan.parentNode;
                    // Move all children of the highlighted span directly to its parent
                    while (highlightedSpan.firstChild) {
                        parentOfHighlighted.insertBefore(highlightedSpan.firstChild, highlightedSpan);
                    }
                    // Remove the now empty highlighted span
                    parentOfHighlighted.removeChild(highlightedSpan);

                    selection.removeAllRanges(); // Clear the selection
                    selection.collapseToEnd(); // Collapse cursor after the cleared text
                    console.log("Highlight cleared successfully.");
                } else {
                    console.log("No highlight span found in selection path to clear.");
                    alert("No highlight found on the selected text or nearby. Please ensure you select an already highlighted portion.");
                }
                floatingToolbar.classList.add('hidden'); // Always hide toolbar after action
                lastSelectionRange = null; // Clear stored range
            }

            // Event listeners for toolbar buttons
            toolbarYellow.addEventListener('click', () => applyHighlight('highlight-yellow'));
            toolbarBlue.addEventListener('click', () => applyHighlight('highlight-blue'));
            toolbarGreen.addEventListener('click', () => applyHighlight('highlight-green'));
            toolbarPink.addEventListener('click', () => applyHighlight('highlight-pink'));
            toolbarClearBtn.addEventListener('click', clearSelectedHighlight);

            // Show/hide toolbar on text selection (mouseup event)
            testContainer.addEventListener('mouseup', (event) => {
                const selection = window.getSelection();
                // Check if there's a selection and it's not collapsed (i.e., actual text is selected)
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    lastSelectionRange = selection.getRangeAt(0).cloneRange(); // Store a *clone* of the range
                    const rect = selection.getRangeAt(0).getBoundingClientRect();
                    const toolbarHeight = floatingToolbar.offsetHeight;
                    const toolbarWidth = floatingToolbar.offsetWidth;

                    let topPos = rect.top + window.scrollY - toolbarHeight - 10;
                    let leftPos = rect.left + window.scrollX + (rect.width / 2) - (toolbarWidth / 2);

                    topPos = Math.max(10, topPos);
                    leftPos = Math.max(10, leftPos);
                    leftPos = Math.min(leftPos, window.innerWidth - toolbarWidth - 10);

                    floatingToolbar.style.top = `${topPos}px`;
                    floatingToolbar.style.left = `${leftPos}px`;
                    floatingToolbar.classList.remove('hidden');
                    console.log("Selection made, toolbar shown.");
                } else {
                    floatingToolbar.classList.add('hidden');
                    // Do NOT clear lastSelectionRange here. If the user clicks outside but doesn't explicitly unselect,
                    // we want to preserve the last selection so they can re-click it and highlight.
                    // lastSelectionRange = null; // Removed this line
                    console.log("No selection, toolbar hidden.");
                }
            });

            // Hide toolbar when clicking outside the toolbar or test container
            document.addEventListener('mousedown', (event) => {
                // If the click is not inside the toolbar AND not inside the main test content area.
                // This ensures clicks *within* the test content (like on an input field) don't hide the toolbar immediately,
                // but only if a selection isn't active.
                if (!floatingToolbar.contains(event.target) && !testContainer.contains(event.target)) {
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null; // Clear last selection only if clicking completely outside
                    console.log("Click outside, toolbar hidden and selection cleared.");
                } else if (testContainer.contains(event.target) && window.getSelection().isCollapsed) {
                    // If clicking within the test container but no text is selected (or selection collapsed), hide toolbar.
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null; // Clear last stored range as the user effectively de-selected
                    console.log("Click inside test container but no selection, toolbar hidden.");
                }
            });


            // --- Main Test Navigation and Rendering ---
            // Initial render and setup for Section 1
            showSection('section1');
            // When starting a new test or navigating back to Section 1, reset the score
            score = 0; // Reset score when starting the test or navigating to the first section
            renderQuestions('section1', 'part1', testData.section1.part1); // This will attach listeners to hardcoded inputs

            // Navigate to Section 2
            document.getElementById('nextSection1').addEventListener('click', () => {
                checkAnswers('section1', 'part1');
                showSection('section2');
                renderQuestions('section2', 'part1', testData.section2.part1); // Render MCQs for S2P1
                renderQuestions('section2', 'part2', testData.section2.part2); // Render/attach for table S2P2
            });

            // Navigate to Section 3
            document.getElementById('nextSection2').addEventListener('click', () => {
                checkAnswers('section2', 'part1');
                checkAnswers('section2', 'part2');
                showSection('section3');
                renderQuestions('section3', 'part1', testData.section3.part1); // Render/attach for matching S3P1
                renderQuestions('section3', 'part2', testData.section3.part2); // Render MCQs for S3P2
                renderQuestions('section3', 'part3', testData.section3.part3); // Render checkbox for S3P3
            });

            // Navigate to Section 4
            document.getElementById('nextSection3').addEventListener('click', () => {
                checkAnswers('section3', 'part1');
                checkAnswers('section3', 'part2');
                checkAnswers('section3', 'part3');
                showSection('section4');
                renderQuestions('section4', 'part1', testData.section4.part1); // Render/attach for fill-in-the-blanks S4P1
            });

            // Submit test
            document.getElementById('submitTest').addEventListener('click', () => {
                checkAnswers('section4', 'part1');
                showResults();
            });

            // Download PDF Report
            document.getElementById('downloadPdf').addEventListener('click', generatePdfReport);

            // Back buttons navigation
            document.getElementById('backSection2').addEventListener('click', () => {
                showSection('section1');
                // Re-render or re-attach listeners if content was modified or cleared on navigation
                renderQuestions('section1', 'part1', testData.section1.part1);
            });

            document.getElementById('backSection3').addEventListener('click', () => {
                showSection('section2');
                renderQuestions('section2', 'part1', testData.section2.part1);
                renderQuestions('section2', 'part2', testData.section2.part2);
            });

            document.getElementById('backSection4').addEventListener('click', () => {
                showSection('section3');
                renderQuestions('section3', 'part1', testData.section3.part1);
                renderQuestions('section3', 'part2', testData.section3.part2);
                renderQuestions('section3', 'part3', testData.section3.part3);
            });
        }; // End of window.onload
    </script>
</body>
</html>
