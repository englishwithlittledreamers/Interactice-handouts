<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Passage 1: Interactive Worksheet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Changed to white */
        }
        /* Style for disabled radio buttons */
        input[type='radio'].form-radio:disabled {
            opacity: 0.7; /* Make them slightly faded when disabled */
            cursor: not-allowed;
        }

        /* Style for radio buttons */
        input[type='radio'].form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-radius: 100%;
            height: 1.25em;
            width: 1.25em;
            border: 2px solid #D1D5DB; /* gray-300 */
            background-color: #F9FAFB; /* gray-50 */
            transition: all 0.2s ease-in-out;
        }
        input[type='radio'].form-radio:checked {
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
        }
        input[type='radio'].form-radio:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.45); /* blue-500 with opacity */
        }

        /* Ensure input fields don't wrap text onto the next line awkwardly */
        .input-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping for small screens */
            align-items: center;
            gap: 0.5rem; /* Space between elements */
        }
        .input-container input[type="text"] {
            flex-grow: 1; /* Allow input to grow */
            min-width: 150px; /* Minimum width for input */
        }
        /* Highlight styles */
        .highlight-yellow { background-color: #FEF9C3; } /* Yellow-100 */
        .highlight-blue { background-color: #DBEAFE; } /* Blue-100 */
        .highlight-green { background-color: #D1FAE5; } /* Green-100 */
        .highlight-pink { background-color: #FCE7F3; } /* Pink-100 */
        .highlighted-text {
            /* Ensures highlighted text is treated as a single unit for selection */
            display: inline;
        }

        /* Adjust for very small screens if necessary */
        @media (max-width: 640px) {
            .input-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .input-container input {
                width: 100%; /* Full width on small screens */
            }
            /* Adjusted for TFNG questions to ensure stacking on small screens too */
            .tfng-question .question-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .tfng-question .options-row {
                justify-content: flex-start; /* Align radio buttons to start */
                margin-left: 0; /* Remove specific left margin */
                padding-left: 2rem; /* Add padding for alignment under number */
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 sm:p-8 md:p-10 rounded-xl  w-full max-w-4xl border border-gray-200">
       

        <div id="dictationContent" class="space-y-8 text-gray-700 text-base sm:text-lg leading-relaxed select-text">

            <h2 class="text-1xl sm:text-1xl font-bold text-gray-800 mt-6 mb-4">
                Questions 1–7
            </h2>
            <p class="text-base sm:text-lg text-gray-600 mb-4">
                Do the following statements agree with the information given in Reading Passage 1?
            </p>
            <p class="text-base sm:text-lg text-gray-600 mb-4">
                In boxes 1–7 on your answer sheet write
            </p>
            <ul class="list-disc list-inside space-y-1 text-gray-700 mb-6 ">
                <p><li>TRUE if the statement agrees with the information</br>
                <li>FALSE if the statement contradicts the information</br>
                <li>NOT GIVEN if there is no information on this</p>
            </ul>

            <div class="tfng-question border-b border-gray-200 pb-4" data-question-number="1" data-correct-answer="TRUE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">1</span>
                    <p class="flex-grow">Children as young as six months may demonstrate understanding of certain words.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng1" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng1" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng1" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="2" data-correct-answer="TRUE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">2</span>
                    <p class="flex-grow">The ability to understand meanings precedes the ability to express meanings.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng2" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng2" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng2" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="3" data-correct-answer="NOT GIVEN">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">3</span>
                    <p class="flex-grow">The development of speech in a child under one year of age is an indication of above-average intelligence.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng3" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng3" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng3" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="4" data-correct-answer="FALSE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">4</span>
                    <p class="flex-grow">Young children talk about fixed objects more often than moving objects.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng4" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng4" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng4" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="5" data-correct-answer="FALSE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">5</span>
                    <p class="flex-grow">If young children hurt themselves, they usually try to talk about it.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng5" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng5" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng5" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="6" data-correct-answer="TRUE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">6</span>
                    <p class="flex-grow">When young children say a word, they may be using it in an unusual sense.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng6" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng6" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng6" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>

            <div class="tfng-question border-b border-gray-200 pb-4 pt-4" data-question-number="7" data-correct-answer="FALSE">
                <div class="flex items-start gap-2 question-row">
                    <span class="font-semibold text-xl flex-shrink-0 w-8 text-right">7</span>
                    <p class="flex-grow">Parents can ensure that children understand a word correctly, by pointing as they say it.</p>
                </div>
                <div class="flex items-center space-x-4 mt-2 pl-10 options-row">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng7" value="TRUE">
                        <span class="ml-2 text-base sm:text-lg">TRUE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng7" value="FALSE">
                        <span class="ml-2 text-base sm:text-lg">FALSE</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" class="form-radio text-blue-600" name="tfng7" value="NOT GIVEN">
                        <span class="ml-2 text-base sm:text-lg">NOT GIVEN</span>
                    </label>
                </div>
            </div>


            <h2 class="text-1xl sm:text-1xl font-bold text-gray-800 mt-8 mb-4">
                Questions 8–13
            </h2>
            <p class="text-base sm:text-lg text-gray-600 mb-4">
                Answer the questions below.
            </p>
            <p class="text-base sm:text-lg text-gray-600 mb-6">
                Choose <span class="font-bold">NO MORE THAN TWO WORDS AND/OR A NUMBER</span> from the passage for each answer.
            </p>
            <p class="text-base sm:text-lg text-gray-600 mb-6">
                Write your answers in boxes 8–13 on your answer sheet.
            </p>

            <div class="space-y-4">
                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">8</span> Which word is given as an example of possible under-generalisation?
                        <input type="text" id="blank8" data-correct-answer="HOUSE"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>

                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">9</span> Which word is given as an example of possible over-generalisation?
                        <input type="text" id="blank9" data-correct-answer="DADDY"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>

                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">10</span> When children stop over- and under-generalising, approximately how many words can they say?
                        <input type="text" id="blank10" data-correct-answer="75/SEVENTY FIVE"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>

                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">11</span> Which word’s meaning do young children hardly ever confuse with ‘rabbit’?
                        <input type="text" id="blank11" data-correct-answer="GROUND"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>

                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">12</span> What are children’s early sentences compared to?
                        <input type="text" id="blank12" data-correct-answer="TEXT MESSAGES"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>

                <div class="input-container pl-4">
                    <p class="text-gray-700"><span class="font-semibold">13</span> Which characteristic of children’s first simple sentences makes them easy to understand?
                        <input type="text" id="blank13" data-correct-answer="ORGANIZATION/ORGANISATION"
                                   class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all duration-200">
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
            <button id="checkAnswersBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                    disabled>
                Check Answers
            </button>
            <button id="saveResultsBtn"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
                    disabled>
                Download Results (PDF)
            </button>
        </div>

        <div id="feedback" class="mt-6 text-center text-lg font-semibold text-gray-800"></div>

        <!-- The resultsTableSection has been removed from here as per request -->
    </div>

    <!-- Floating Highlight Toolbar -->
    <div id="floatingToolbar" class="absolute hidden bg-gray-800 p-2 rounded-lg shadow-xl flex items-center space-x-2 z-50">
        <button id="toolbarClearBtn" title="Clear Highlight" class="p-1 rounded-full bg-gray-600 hover:bg-gray-700 text-white text-lg leading-none flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
            </svg>
        </button>
        <div id="toolbarYellow" title="Highlight Yellow" class="w-6 h-6 rounded-full cursor-pointer bg-yellow-400 hover:bg-yellow-500 transition-colors duration-200" data-color="highlight-yellow"></div>
        <div id="toolbarBlue" title="Highlight Blue" class="w-6 h-6 rounded-full cursor-pointer bg-blue-400 hover:bg-blue-500 transition-colors duration-200" data-color="highlight-blue"></div>
        <div id="toolbarGreen" title="Highlight Green" class="w-6 h-6 rounded-full cursor-pointer bg-green-400 hover:bg-green-500 transition-colors duration-200" data-color="highlight-green"></div>
        <div id="toolbarPink" title="Highlight Pink" class="w-6 h-6 rounded-full cursor-pointer bg-pink-400 hover:bg-pink-500 transition-colors duration-200" data-color="highlight-pink"></div>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tfngQuestions = document.querySelectorAll('.tfng-question');
            const wordBlanks = document.querySelectorAll('input[type="text"]');
            const checkAnswersBtn = document.getElementById('checkAnswersBtn');
            const saveResultsBtn = document.getElementById('saveResultsBtn');
            const feedbackDiv = document.getElementById('feedback');
            const dictationContent = document.getElementById('dictationContent');

            // Floating toolbar elements
            const floatingToolbar = document.getElementById('floatingToolbar');
            const toolbarClearBtn = document.getElementById('toolbarClearBtn');
            const toolbarYellow = document.getElementById('toolbarYellow');
            const toolbarBlue = document.getElementById('toolbarBlue');
            const toolbarGreen = document.getElementById('toolbarGreen');
            const toolbarPink = document.getElementById('toolbarPink');

            let currentHighlights = []; // Stores highlight data: { text: "...", color: "..." }
            let lastSelectionRange = null; // Stores the last text selection range
            let answersCheckedFlag = false; // Flag to track if answers have been checked

            // --- Highlighting Logic ---
            function applyHighlight(colorClass) {
                const selection = window.getSelection();
                let range;

                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    range = selection.getRangeAt(0);
                } else if (lastSelectionRange) {
                    range = lastSelectionRange;
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    feedbackDiv.textContent = "No text selected or previously selected to highlight.";
                    feedbackDiv.classList.add('text-red-600');
                    return;
                }

                const selectedText = range.toString().trim();
                if (!selectedText) return;

                const span = document.createElement('span');
                span.classList.add(colorClass);
                span.classList.add('highlighted-text');

                try {
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);

                    const existingHighlight = currentHighlights.find(
                        h => h.text === selectedText && h.color === colorClass.replace('highlight-', '')
                    );
                    if (!existingHighlight) {
                        currentHighlights.push({
                            text: selectedText,
                            color: colorClass.replace('highlight-', '')
                        });
                    }

                    selection.removeAllRanges();
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null;
                } catch (e) {
                    console.error("Error applying highlight:", e);
                    feedbackDiv.textContent = "Could not highlight complex selection. Try selecting less text.";
                    feedbackDiv.classList.add('text-red-600');
                }
            }

            function clearSelectedHighlight() {
                const selection = window.getSelection();
                let range;

                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    range = selection.getRangeAt(0);
                } else if (lastSelectionRange) {
                    range = lastSelectionRange;
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    feedbackDiv.textContent = "No text selected or previously selected to clear highlight.";
                    feedbackDiv.classList.add('text-red-600');
                    return;
                }

                const selectedNode = range.commonAncestorContainer;
                let highlightedSpan = null;

                if (selectedNode && selectedNode.nodeType === Node.ELEMENT_NODE && selectedNode.classList.contains('highlighted-text')) {
                    highlightedSpan = selectedNode;
                } else {
                    let currentNode = selectedNode;
                    while (currentNode && currentNode !== dictationContent && currentNode.parentNode) {
                        if (currentNode.nodeType === Node.ELEMENT_NODE && currentNode.classList.contains('highlighted-text')) { // Corrected element type
                            highlightedSpan = currentNode;
                            break;
                        }
                        currentNode = currentNode.parentNode;
                    }
                }

                if (highlightedSpan && highlightedSpan.parentNode) {
                    const textContent = highlightedSpan.textContent;
                    highlightedSpan.parentNode.replaceChild(document.createTextNode(textContent), highlightedSpan);

                    currentHighlights = currentHighlights.filter(h => h.text.toLowerCase() !== textContent.toLowerCase());

                    selection.removeAllRanges();
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null;
                    feedbackDiv.textContent = "Highlight cleared.";
                    feedbackDiv.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
                } else {
                    feedbackDiv.textContent = "No highlight found to clear for this selection.";
                    feedbackDiv.classList.add('text-red-600');
                }
            }

            // --- Event Listeners for Toolbar ---
            toolbarYellow.addEventListener('click', () => applyHighlight('highlight-yellow'));
            toolbarBlue.addEventListener('click', () => applyHighlight('highlight-blue'));
            toolbarGreen.addEventListener('click', () => applyHighlight('highlight-green'));
            toolbarPink.addEventListener('click', () => applyHighlight('highlight-pink'));
            toolbarClearBtn.addEventListener('click', clearSelectedHighlight);

            dictationContent.addEventListener('mouseup', (event) => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    lastSelectionRange = selection.getRangeAt(0);
                    const rect = lastSelectionRange.getBoundingClientRect();
                    const toolbarHeight = floatingToolbar.offsetHeight;
                    const toolbarWidth = floatingToolbar.offsetWidth;

                    floatingToolbar.style.top = `${rect.top + window.scrollY - toolbarHeight - 10}px`;
                    let leftPos = rect.left + window.scrollX + (rect.width / 2) - (toolbarWidth / 2);
                    leftPos = Math.max(10, leftPos);
                    leftPos = Math.min(leftPos, window.innerWidth - toolbarWidth - 10);
                    floatingToolbar.style.left = `${leftPos}px`;

                    floatingToolbar.classList.remove('hidden');
                } else {
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null;
                }
            });

            document.addEventListener('mousedown', (event) => {
                if (!floatingToolbar.contains(event.target) && !dictationContent.contains(event.target)) {
                    floatingToolbar.classList.add('hidden');
                    lastSelectionRange = null;
                }
            });

            // --- Worksheet Functionality ---
            function getResults() {
                const results = [];
                let correctCount = 0;
                const totalQuestions = tfngQuestions.length + wordBlanks.length;

                tfngQuestions.forEach(qDiv => {
                    const questionNumber = qDiv.dataset.questionNumber;
                    const correctAnswer = qDiv.dataset.correctAnswer.toLowerCase();
                    const selectedRadio = qDiv.querySelector(`input[name="tfng${questionNumber}"]:checked`);
                    const userAnswer = selectedRadio ? selectedRadio.value.toLowerCase() : "No answer";
                    const statement = qDiv.querySelector('p').textContent.trim();

                    let isCorrect = (userAnswer === correctAnswer);
                    if (isCorrect) {
                        correctCount++;
                    }
                    results.push({
                        type: 'TFNG',
                        questionNumber: parseInt(questionNumber),
                        statement: statement,
                        userAnswer: selectedRadio ? selectedRadio.value : "No answer",
                        correctAnswer: qDiv.dataset.correctAnswer,
                        isCorrect: isCorrect
                    });
                });

                wordBlanks.forEach(input => {
                    const questionNumber = parseInt(input.id.replace('blank', ''));
                    const userAnswer = input.value.trim();
                    const correctAnswer = input.dataset.correctAnswer.trim();

                    let isCorrect = (userAnswer.toLowerCase() === correctAnswer.toLowerCase());
                    if (isCorrect) {
                        correctCount++;
                    }
                    results.push({
                        type: 'BLANK',
                        questionNumber: questionNumber,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect
                    });
                });

                return { results, correctCount, totalQuestions }; // Return all relevant data for PDF
            }

            // Function to check if all questions have an answer
            function areAllQuestionsAnswered() {
                let allTFNGAnswered = true;
                tfngQuestions.forEach(qDiv => {
                    const selectedRadio = qDiv.querySelector(`input[name="tfng${qDiv.dataset.questionNumber}"]:checked`);
                    if (!selectedRadio) {
                        allTFNGAnswered = false;
                    }
                });

                let allBlanksFilled = true;
                wordBlanks.forEach(input => {
                    if (input.value.trim() === '') {
                        allBlanksFilled = false;
                    }
                });
                return allTFNGAnswered && allBlanksFilled;
            }

            // Function to update button states based on completion and answers checked
            function updateButtonStates() {
                if (areAllQuestionsAnswered()) {
                    checkAnswersBtn.disabled = false;
                    checkAnswersBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    checkAnswersBtn.disabled = true;
                    checkAnswersBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                if (answersCheckedFlag) {
                    saveResultsBtn.disabled = false;
                    saveResultsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    saveResultsBtn.disabled = true;
                    saveResultsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            // Function to lock answers after checking
            function lockAnswers() {
                tfngQuestions.forEach(qDiv => {
                    qDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.disabled = true;
                    });
                });
                wordBlanks.forEach(input => {
                    input.readOnly = true;
                    input.classList.add('cursor-not-allowed'); // Visual cue for read-only
                });
            }

            // Initial state for buttons
            updateButtonStates();

            checkAnswersBtn.addEventListener('click', () => {
                getResults(); // This will get the results but not display score on page
                lockAnswers(); // Lock the answers immediately after checking
                answersCheckedFlag = true; // Set flag to true after checking answers
                updateButtonStates(); // Update button states to enable download
                feedbackDiv.textContent = "Answers checked! Download your PDF for results."; // Updated neutral feedback
                feedbackDiv.classList.remove('text-green-600', 'text-red-600', 'text-blue-600'); // Ensure neutral color
            });

            saveResultsBtn.addEventListener('click', () => {
                const { results: allResults, correctCount, totalQuestions } = getResults(); // Get all results including score

                feedbackDiv.textContent = "Generating PDF...";
                feedbackDiv.classList.remove('text-green-600', 'text-red-600');
                feedbackDiv.classList.add('text-blue-600');

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(22);
                    doc.text("Reading Passage 1: Your Results", 105, 20, null, null, "center");

                    doc.setFontSize(14);
                    doc.text(`Report generated on: ${new Date().toLocaleString()}`, 10, 30);
                    doc.text(`Total Score: ${correctCount} out of ${totalQuestions} correct!`, 10, 40); // Display total score in PDF

                    // Answers Table
                    doc.setFontSize(16);
                    doc.text("Your Answers", 10, 60); // Adjusted Y position

                    const tableColumn = ["Question #", "Your Answer", "Correct Answer", "Status"];
                    const tableRows = [];

                    allResults.sort((a, b) => a.questionNumber - b.questionNumber);

                    allResults.forEach(result => {
                        const status = result.isCorrect ? "Correct" : "Incorrect";
                        tableRows.push([
                            result.questionNumber.toString(),
                            result.userAnswer || "No answer",
                            result.correctAnswer,
                            status
                        ]);
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 65, // Adjusted Y position
                        theme: 'striped',
                        styles: {
                            fontSize: 10,
                            cellPadding: 2,
                            fillColor: [255, 255, 255],
                            textColor: [51, 51, 51],
                            lineColor: [200, 200, 200],
                            lineWidth: 0.1,
                            overflow: 'linebreak',
                        },
                        headStyles: {
                            fillColor: [220, 230, 240],
                            textColor: [0, 0, 0],
                            fontStyle: 'bold'
                        },
                        columnStyles: {
                            0: { cellWidth: 20 },
                            1: { cellWidth: 55 },
                            2: { cellWidth: 55 },
                            3: { cellWidth: 30, halign: 'center' }
                        },
                        didDrawCell: (data) => {
                            if (data.section === 'body' && data.column.index === 3) {
                                const status = data.cell.text[0];
                                if (status === 'Correct') {
                                    doc.setFillColor(144, 238, 144);
                                } else {
                                    doc.setFillColor(255, 182, 193);
                                }
                                doc.rect(data.cell.x + data.cell.padding('left'), data.cell.y + data.cell.padding('top'), data.cell.width - data.cell.padding('left') - data.cell.padding('right'), data.cell.height - data.cell.padding('top') - data.cell.padding('bottom'), 'F');
                                doc.setTextColor(0, 0, 0);
                                doc.text(status, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { align: 'center', baseline: 'middle' });
                            }
                        }
                    });

                    let finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(16);
                    doc.text("Your Highlights", 10, finalY);
                    finalY += 10;

                    if (currentHighlights.length > 0) {
                        doc.setFontSize(12);
                        currentHighlights.forEach((h) => {
                            const textLines = doc.splitTextToSize(`- "${h.text}" (Color: ${h.color})`, doc.internal.pageSize.width - 25);
                            doc.text(textLines, 15, finalY);
                            finalY += (textLines.length * 7);
                        });
                    } else {
                        doc.setFontSize(12);
                        doc.setTextColor(150, 150, 150);
                        doc.text("No highlights were made.", 15, finalY);
                    }

                    const filename = `reading_passage_results_${new Date().toISOString().slice(0,10)}.pdf`;
                    doc.save(filename);

                    feedbackDiv.textContent = "Results PDF generated and downloaded!";
                    feedbackDiv.classList.remove('text-blue-600');
                    feedbackDiv.classList.add('text-green-600');

                } catch (error) {
                    feedbackDiv.textContent = `An error occurred during PDF generation: ${error.message}`;
                    feedbackDiv.classList.remove('text-blue-600');
                    feedbackDiv.classList.add('text-red-600');
                    console.error('Error generating PDF:', error);
                }
            });

            // Event listeners to update button states when input changes
            wordBlanks.forEach(input => {
                input.addEventListener('input', () => {
                    feedbackDiv.textContent = ''; // Clear score message
                    answersCheckedFlag = false; // Reset flag if user changes answers after checking
                    updateButtonStates(); // Re-evaluate button states
                });
            });

            tfngQuestions.forEach(qDiv => {
                qDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        feedbackDiv.textContent = ''; // Clear score message
                        answersCheckedFlag = false; // Reset flag if user changes answers after checking
                        updateButtonStates(); // Re-evaluate button states
                    });
                });
            });
        });
    </script>
</body>
</html>
